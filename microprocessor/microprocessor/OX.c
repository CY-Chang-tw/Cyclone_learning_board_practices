#include <stdio.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Scankey.h"
#include "Seven_Segment.h"

unsigned char cross[32] = {
0x06, 0x0f, 0x1f, 0x3e, 0x7c, 0xf8, 0xf0, 0xe0, 0xe0, 0xf0, 0xf8, 0x7c, 0x3e, 0x1f, 0x0f, 0x06, 
0x60, 0xf0, 0xf8, 0x7c, 0x3e, 0x1f, 0x0f, 0x07, 0x07, 0x0f, 0x1f, 0x3e, 0x7c, 0xf8, 0xf0, 0x60
};

unsigned char circle[32] = {
0xe0, 0xf8, 0x1c, 0x0e, 0x06, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x06, 0x0e, 0x1c, 0xf8, 0xe0, 
0x07, 0x1f, 0x38, 0x70, 0x60, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x60, 0x70, 0x38, 0x1f, 0x07
};

unsigned char map[512] = {
// 'pngwing', 64x64px
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xff, 0xff, 0xff, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xff, 0xff, 0xff, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0x40, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x06, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 
0x0e, 0x0e, 0x0e, 0x0e, 0x0f, 0xff, 0xff, 0xff, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 
0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0xff, 0xff, 0xff, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 
0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x06, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x0f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

int square[9]={0,0,0,0,0,0,0,0,0};

void openAll(){

	OpenKeyPad();
	OpenSevenSegment();
	
	GPIO_SetMode(PA, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT14, GPIO_MODE_OUTPUT);
	
	
	GPIO_SetMode(PC, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT14, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT15, GPIO_MODE_OUTPUT);
	
	init_LCD();
	clear_LCD();
	
}

/*
	七段輸出  
	no:第幾個七段? 
	word:輸出什麼字?
	不明白的，可自行寫自己的七段顯示
*/
void showSeven(int no, int num){
	//Init All 4 PC
	CLK_SysTickDelay(1000);
	PC4 = PC5 = PC6 = PC7 = 0;
	switch (no) {
		case 1:
			PC4 = 1;
			break;
		case 2:
			PC5 = 1;
			break;
		case 3:
			PC6 = 1;
			break;
		case 4:
			PC7 = 1;
			break;
	}
	
	//Init All 8 
	PE0 = 1; PE1 = 1; PE2 = 1; PE3 = 1; PE4 = 1; PE5 = 1; PE6 = 1; PE7 = 1;
	//Set 7-Segment's PE
	if (num == 1  || num == 'o' || num == 'n' || num == 'g' || num == 'A' || num == 'S')
		PE0 = 0;
	if (num == 'C' || num == 'g' || num == 'A' || num == 't' || num == 'S' || num == 'P' || num == 'E')
		PE2 = 0;
	if (num == 2  || num == 'C' || num == 'g' || num == 'A' || num == 'S' || num == 'P' || num == 'E')
		PE3 = 0;
	if (num == 1  || num == 2 || num == 'g' || num == 'A' || num == 'P')
		PE4 = 0;
	if (num == '_' || num == 2 || num == 'C' || num == 'o' || num == 'g' || num == 't' || num == 'S' || num == 'E')
		PE5 = 0;
	if (num == 2 || num == 'C' || num == 'o' || num == 'n' || num == 'r' || num == 'A' || num == 't' || num == 'P' || num == 'E')
		PE6 = 0;
	if (num == 2 || num == 'o' || num == 'n' || num == 'g' || num == 'r' || num == 'A' || num == 't' || num == 'P' || num == 'S' || num == 'E')
		PE7 = 0;
}

/*
	跑馬燈輸出  
	result:結果是?平局？勝利？ 
	who:誰？
	不明白的，可自行寫自己的跑馬燈
*/
void ShowMarquee(int result, int who){
	int i,j,k;
	
	if(result==0){
		int marquee[17]={0,0,0,0,'P',1,'_','P',2,'_','t',1,'E',0,0,0,0};
		for(i=0;i<2;i++){
			for(j=0;j<14;j++){
				for(k=0;k<100;k++){
					if(marquee[j]!=0)
						showSeven(4,marquee[j]);
					if(marquee[j+1]!=0)
						showSeven(3,marquee[j+1]);
					if(marquee[j+2]!=0)
						showSeven(2,marquee[j+2]);
					if(marquee[j+3]!=0)
						showSeven(1,marquee[j+3]);
				}
			}
		}	
	}
	else{
		int marquee[17]={0,0,0,0,'C','o','g','r','A','t','S',0,'P',0,0,0,0};
		if(who==1)
			marquee[13]=1;
		else
			marquee[13]=2;
		
		for(i=0;i<2;i++){
			for(j=0;j<14;j++){
				for(k=0;k<100;k++){
					if(marquee[j]!=0)
						showSeven(4,marquee[j]);
					if(marquee[j+1]!=0)
						showSeven(3,marquee[j+1]);
					if(marquee[j+2]!=0)
						showSeven(2,marquee[j+2]);
					if(marquee[j+3]!=0)
						showSeven(1,marquee[j+3]);
				}
			}
		}	
	}
	CloseSevenSegment();
}

/*
	檢查是否勝利？ 已勝利？ 平局？ 還未分出勝負？ 
	不明白的，可自行寫自己的檢測
*/
int checkwin(){
	if(square[0]!=0 && square[0]==square[1] && square[1]==square[2])
		return 1; // Win
	else if(square[3]!=0 && square[3]==square[4] && square[4]==square[5])
		return 1; // Win
	else if(square[6]!=0 && square[6]==square[7] && square[7]==square[8])
		return 1; // Win
	else if(square[0]!=0 && square[0]==square[3] && square[3]==square[6])
		return 1; // Win
	else if(square[1]!=0 && square[1]==square[4] && square[4]==square[7])
		return 1; // Win
	else if(square[2]!=0 && square[2]==square[5] && square[5]==square[8])
		return 1; // Win
	else if(square[0]!=0 && square[0]==square[4] && square[4]==square[8])
		return 1; // Win
	else if(square[2]!=0 && square[2]==square[4] && square[4]==square[6])
		return 1; // Win
	else if(square[0]!=0 && square[1]!=0 && square[2]!=0 && square[3]!=0 && square[4]!=0 && square[5]!=0 && square[6]!=0 && square[7]!=0 && square[8]!=0)
		return 0; // Win
	else
		return -1; // Game still going
}

/*
	畫O X 
	num:在哪裡畫？ 
	shape:O還是X?
	不明白的，可自行寫自己的檢測
*/
void drawShape(int num, int shape){
	int y=0,x=0;
	switch(num){
		case 1:
			x=5,y=5;break;
		case 2:
			x=24,y=5;break;
		case 3:
			x=43,y=5;break;
		case 4:
			x=5,y=25;break;
		case 5:
			x=24,y=25;break;
		case 6:
			x=43,y=25;break;
		case 7:
			x=5,y=45;break;
		case 8:
			x=24,y=45;break;
		case 9:
			x=43,y=45;break;
	}
	
	if(shape==1)
		draw_Bmp16x16(x,y,FG_COLOR,BG_COLOR,circle);
	else
		draw_Bmp16x16(x,y,FG_COLOR,BG_COLOR,cross);
}

int main(void)
{
	
	
	
	int temp=0, who, input, win, i;
	
	SYS_Init();
	openAll();
	
	PD14=0;
	
	while(1){
		//Game Start or New Game
		clear_LCD();
		draw_Bmp64x64(0,0,FG_COLOR,BG_COLOR,map);
		win=-1;who=0;
		
		while(1){
			win = checkwin();
			if(win>=0)break;
			who = (++who%2)?1:2;
			while(temp==0)temp=ScanKey();
			input=temp;
			while(temp!=0)temp=ScanKey();
			
			if(square[input-1]==0){
				square[input-1] = who;
				drawShape(input,who);	
			}
			else{
				who--;
				PA14=0;
				PC12=0;PC13=1;PC14=1;PC15=1;
				CLK_SysTickDelay(500000);
				PA14=1;
				PC12=1;PC13=0;PC14=1;PC15=1;
				CLK_SysTickDelay(500000);
				
				PA14=0;
				PC12=1;PC13=1;PC14=0;PC15=1;
				CLK_SysTickDelay(500000);
				PA14=1;
				PC12=1;PC13=1;PC14=1;PC15=0;
				CLK_SysTickDelay(500000);
				
				PA14=0;
				PC12=1;PC13=1;PC14=1;PC15=1;
				CLK_SysTickDelay(500000);
				PA14=1;
				CLK_SysTickDelay(500000);

			}
			CLK_SysTickDelay(500000);
		
		}
		if(win==0){
			printS(65,20,"Tie");
			ShowMarquee(win,who);
			
			for(i=0;i<4;i++){
				PA12=0;
				PC12=0;PC13=0;PC14=0;PC15=0;
				CLK_SysTickDelay(500000);
				PA12=1;
				PC12=1;PC13=1;PC14=1;PC15=1;
				CLK_SysTickDelay(500000);
			}
		}
		else{
			if(who==1){
				printS(65,20,"Congratz");
				printS(65,32,"Circle");
			}
			else{
				printS(65,20,"Congratz");
				printS(65,32,"Cross");	
			}
			ShowMarquee(win,who);
			
			for(i=0;i<4;i++){
				PA13=0;
				PC12=0;PC13=0;PC14=0;PC15=0;
				CLK_SysTickDelay(500000);
				PA13=1;
				PC12=1;PC13=1;PC14=1;PC15=1;
				CLK_SysTickDelay(500000);
			}
		}
		while(temp==0)
			temp=ScanKey();
		while(temp!=0)
			temp=ScanKey();
		for(i=0;i<9;i++)
			square[i]=0;
		CLK_SysTickDelay(500000);
		
	}
}
